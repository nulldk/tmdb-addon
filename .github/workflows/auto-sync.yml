name: Sincronizaci贸n Autom谩tica

on:
  schedule:
    - cron: '0 0 * * *' # Ejecutar a medianoche
  workflow_dispatch: # Bot贸n manual

permissions:
  contents: write # Permiso para hacer git push
  issues: write   # Permiso para crear la alerta

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Intentar Merge con Upstream
        id: merge
        run: |
          # --- CONFIGURACIN ---
          UPSTREAM_URL="https://github.com/mrcanelas/tmdb-addon.git"
          BRANCH="main"
          # ---------------------

          git remote add upstream $UPSTREAM_URL
          git fetch upstream
          git checkout $BRANCH

          # AQUI ESTA EL CAMBIO PRINCIPAL: --allow-unrelated-histories
          # Esto fuerza la uni贸n aunque los repositorios parezcan distintos
          git merge upstream/$BRANCH --allow-unrelated-histories
          
          git push origin $BRANCH

      - name:  ALERTA - Crear Issue por Fallo
        if: failure() # Se ejecuta si el merge falla (por conflictos de archivos)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # He quitado la linea --assignee para evitar el error de usuario no encontrado
          gh issue create \
            --title "锔 Fallo de Sincronizaci贸n: Conflicto Detectado" \
            --body "La sincronizaci贸n autom谩tica ha fallado. Hay conflictos de c贸digo que debes resolver manualmente en tu PC. Revisa https://github.com/${{ github.repository }}"
